# ============================================================================
# CONFIGURATION DE SÉCURITÉ - Chauffage-Vosges
# ============================================================================

# Activer le moteur de réécriture
RewriteEngine On

# ============================================================================
# PROTECTION DES RÉPERTOIRES
# ============================================================================

# Interdire l'accès aux répertoires sensibles
RedirectMatch 403 ^/(app|data|storage|scripts|config)/.*$

# Interdire l'accès aux fichiers sensibles
<FilesMatch "^\.">
  Order allow,deny
  Deny from all
</FilesMatch>

<FilesMatch "\.(git|gitignore|gitattributes|lock|log|md|sql|sqlite)$">
  Order allow,deny
  Deny from all
</FilesMatch>

# Protéger les fichiers de configuration
<Files "config.php">
  Order allow,deny
  Deny from all
</Files>

<Files "composer.json">
  Order allow,deny
  Deny from all
</Files>

<Files "composer.lock">
  Order allow,deny
  Deny from all
</Files>

# ============================================================================
# HEADERS DE SÉCURITÉ HTTP
# ============================================================================

<IfModule mod_headers.c>
  # Protection contre le clickjacking
  Header always set X-Frame-Options "SAMEORIGIN"
  
  # Protection XSS navigateur
  Header always set X-XSS-Protection "1; mode=block"
  
  # Empêcher MIME sniffing
  Header always set X-Content-Type-Options "nosniff"
  
  # Referrer Policy
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  
  # Permissions Policy
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), fullscreen=(self)"
  
  # Content Security Policy
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://*.tile.openstreetmap.org blob:; connect-src 'self'; media-src 'self'; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';"
  
  # Supprimer les headers qui révèlent des informations
  Header always unset X-Powered-By
  Header always unset Server
  Header always unset X-Generator
</IfModule>

# ============================================================================
# STRICT TRANSPORT SECURITY (HTTPS)
# ============================================================================

<IfModule mod_headers.c>
  <If "%{HTTPS} == 'on'">
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  </If>
</IfModule>

# ============================================================================
# RÉÉCRITURE URL (Front Controller)
# ============================================================================

# Ne pas réécrire les fichiers et répertoires existants
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Réécrire tout vers index.php
RewriteRule ^ index.php [L]

# ============================================================================
# COMPRESSION
# ============================================================================

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# ============================================================================
# CACHE NAVIGATEUR
# ============================================================================

<IfModule mod_expires.c>
  ExpiresActive On
  
  # Images
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  
  # CSS et JavaScript
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  
  # Fonts
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  
  # HTML (ne pas cacher les pages dynamiques)
  ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ============================================================================
# PROTECTION CONTRE LES METHODES HTTP DANGEREUSES
# ============================================================================

<IfModule mod_rewrite.c>
  RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS|HEAD)
  RewriteRule .* - [F]
</IfModule>

# ============================================================================
# LIMITER LA TAILLE DES REQUÊTES
# ============================================================================

# Limite à 10MB pour les uploads (ajuster selon besoins)
LimitRequestBody 10485760

# ============================================================================
# PROTECTION CONTRE LES INJECTIONS
# ============================================================================

<IfModule mod_rewrite.c>
  # Bloquer les tentatives de directory traversal
  RewriteCond %{QUERY_STRING} \.\./ [NC,OR]
  RewriteCond %{QUERY_STRING} \.\.\\ [NC,OR]
  RewriteCond %{QUERY_STRING} %2e%2e%2f [NC,OR]
  RewriteCond %{QUERY_STRING} %2e%2e\\ [NC]
  RewriteRule .* - [F]
  
  # Bloquer les tentatives d'injection SQL basiques
  RewriteCond %{QUERY_STRING} (union|select|insert|update|delete|drop|create|alter) [NC]
  RewriteCond %{QUERY_STRING} (from|into|table|database|where) [NC]
  RewriteRule .* - [F]
</IfModule>

# ============================================================================
# INTERDIRE LE LISTING DES RÉPERTOIRES
# ============================================================================

Options -Indexes

# ============================================================================
# ENCART PHP (si mod_php utilisé)
# ============================================================================

<IfModule mod_php.c>
  php_flag display_errors Off
  php_flag log_errors On
  php_value error_log ../storage/logs/php_errors.log
  php_flag expose_php Off
  php_flag allow_url_fopen Off
  php_flag allow_url_include Off
</IfModule>
